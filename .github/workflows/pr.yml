name: PR

on: pull_request

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Ubuntu Latest (GCC)
            os: ubuntu-latest
            build_type: Debug
            test_path: CommonTest
            cc: gcc
            cxx: g++
            code_coverage: true

          - name: macOS Latest (Clang)
            os: macos-latest
            build_type: Release
            test_path: CommonTest
            cc: clang
            cxx: clang++

          - name: Windows Latest (MSVC)
            os: windows-latest
            build_type: Release
            test_path: Release/CommonTest
            cc: cl
            cxx: cl

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Prepare
        run: mkdir build

      - name: Configure
        working-directory: ./build
        run: cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }} -DCODE_COVERAGE=${{ matrix.config.code_coverage && 'ON' || 'OFF' }}

      - name: Build
        working-directory: ./build
        run: cmake --build . --config ${{ matrix.config.build_type }}

      - name: Test
        working-directory: ./build
        run: ./test/${{ matrix.config.test_path }}

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: ${{ matrix.config.code_coverage }}
        with:
          verbose: true
          gcov: true
          gcov_ignore:
            /usr/include*
